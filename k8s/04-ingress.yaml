# ─────────────────────────────────────────────
#  INGRESS — AWS ALB Ingress Controller
#  kubectl apply -f 04-ingress.yaml
#
#  PREREQUISITES:
#  1. AWS Load Balancer Controller must be installed in your cluster
#     helm repo add eks https://aws.github.io/eks-charts
#     helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
#       -n kube-system \
#       --set clusterName=<YOUR_CLUSTER_NAME> \
#       --set serviceAccount.create=false \
#       --set serviceAccount.name=aws-load-balancer-controller
#
#  2. Subnets must be tagged:
#     Public subnets  → kubernetes.io/role/elb = 1
#     Private subnets → kubernetes.io/role/internal-elb = 1
#
#  HOW ROUTING WORKS:
#  ALB URL /          → login-service   (Login Page)
#  ALB URL /order     → order-service   (Order Page)
#  ALB URL /payment   → payment-service (Payment Page)
# ─────────────────────────────────────────────

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hiqode-ingress
  namespace: hiqode
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing  # ── ALB facing the internet (use "internal" for private) ──
    alb.ingress.kubernetes.io/target-type: ip  # ── Use IP mode (required for Fargate; works for EC2 too) ─
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'   # ── ALB Listener port ─
    alb.ingress.kubernetes.io/healthcheck-path: /  # ── Health check path ──
    alb.ingress.kubernetes.io/tags: Environment=demo,Team=hiqode  # ── Tags on the ALB (optional but good practice) ──
    alb.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: alb         # ← NEW WAY (replaces the annotation)
  rules:
    - http:
        paths:
          - path: /order                   # ── /order → Order Service ──
            pathType: Prefix
            backend:
              service:
                name: order-service
                port:
                  number: 80
          - path: /payment                  # ── /payment → Payment Service ──
            pathType: Prefix
            backend:
              service:
                name: payment-service
                port:
                  number: 80
          - path: /                        # ── / (root) → Login Service — MUST be last ──
            pathType: Prefix
            backend:
              service:
                name: login-service
                port:
                  number: 80
